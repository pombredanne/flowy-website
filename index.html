<html>
<head>
    <title>Flowy</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <link rel="stylesheet" href="css/index.css" type="text/css" media="screen" title="no title" charset="utf-8">
</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Flowy</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">Documentation</a></li>
            <li><a href="#">Contribute</a></li>
            <li><a href="#">Download</a></li>
            <li><a href="#">Contact</a></li>
          </ul>
          <form class="navbar-form navbar-right">
            <input type="text" class="form-control" placeholder="Search...">
          </form>
        </div>
      </div>
    </div>
<div class="container">
    <div class="row">
        <div class="col-md-4 col-md-offset-4">
            <h3>Try Flowy</h3>
        </div>
    </div>
    <div class="row">
        <div class="col-md-5">
            <pre id="flowy_workflow">
@Workflow('MyWorkflow', 4, 'my_list')
class MyWorkflow(Workflow):
    sum = ActivityProxy('sum', 1)
    square = ActivityProxy('square', 1)

    def run(self, input): </pre>
            <textarea id="yourcode" cols="40" rows="10">self.sum(1,2,3)
self.square(2)</textarea>
            <button type="button" class="center-block" id="run_button">Run</button>
            <pre id="output"> </pre>
        </div>
    <div class="col-md-6" id="result">
        </div>
    </div>
</div>

<script src="js/jquery.js" type="text/javascript"></script>
<script src="js/Ractive.js" type="text/javascript"></script>
<script src="js/brython.js" type="text/javascript"></script>
<script src="js/bootstrap.min.js" type="text/javascript"></script>
<script id="template" type='ractive'>
        <div id="priority_queue" class="stack_wrapper">
            <div class="stack">
                {{#priority_activities}}
                    <div class="activity" data-id="{{id}}">
                        <span class="name">{{name}}</span>
                        <span class="inputs">{{inputs}}</span>
                        <span class="result">{{result}}</span>
                        <button class="finish"><span class="glyphicon glyphicon-ok"></span></button>
                        <button class="error"><span class="glyphicon glyphicon-remove"></span></button>
                        <button class="timeout"><span class="glyphicon glyphicon-time"></span></button>
                    </div>
                {{/priority_activities}}
            </div>
            <div class="queue_name">
                Priority queue
            </div>
        </div>
        <div id="normal_queue" class="stack_wrapper">
            <div id="normal" class="stack">
                {{#normal_activities}}
                    <div class="activity" data-id="{{id}}">
                        <span class="name">{{name}}</span>
                        <span class="inputs">{{inputs}}</span>
                        <span class="result">{{result}}</span>
                        <button class="finish"><span class="glyphicon glyphicon-ok"></span></button>
                        <button class="error"><span class="glyphicon glyphicon-remove"></span></button>
                        <button class="timeout"><span class="glyphicon glyphicon-time"></span></button>
                    </div>
                {{/normal_activities}}
            </div>
            <div class="queue_name">
                Normal queue
            </div>
        </div>
        <div id="backup_queue" class="stack_wrapper">
            <div class="stack">
                {{#backup_activities}}
                    <div class="activity" data-id="{{id}}">
                        <span class="name">{{name}}</span>
                        <span class="inputs">{{inputs}}</span>
                        <span class="result">{{result}}</span>
                        <button class="finish"><span class="glyphicon glyphicon-ok"></span></button>
                        <button class="error"><span class="glyphicon glyphicon-remove"></span></button>
                        <button class="timeout"><span class="glyphicon glyphicon-time"></span></button>
                    </div>
                {{/backup_activities}}
            </div>
            <div class="queue_name">
                Backup queue
            </div>
        </div>
</script>
<script type="text/javascript">
    priority_activities = [{name:'sum', id: '1', inputs: '[1,2,3]', result: '6'}];
    normal_activities = [];
    backup_activities = [];

ractive = new Ractive({
  el: 'result',
  template: '#template',
        data: {
            priority_activities: priority_activities,
            normal_activities: normal_activities,
            backup_activities: backup_activities
        }
});
</script>
<script type="text/python">
from browser import doc
from flowy.exception import SuspendTask, TaskError, TaskTimedout
from flowy.result import Placeholder, Error, Timeout, Result
from flowy.task import Workflow
from flowy.scheduler import OptionsScheduler, ArgsDependencyScheduler
from flowy.swf.scheduler import DecisionScheduler
from javascript import JSObject
import json

running = []
errors = {}
timedout = []
results = {}

pq = JSObject(priority_activities)
nq = JSObject(normal_activities)
bq = JSObject(backup_activities)

def square(x):
    return x**2

class Client(object):

    def respond_decision_task_completed(self, task_token, decisions):
        for decision in decisions:
            print(decision)
            dt = decision['decisionType']
            if dt == 'ScheduleActivityTask':
                print('in if')
                atrs = decision['scheduleActivityTaskDecisionAttributes']
                name = atrs['activityType']['name']
                task_list = atrs['taskList']['name']
                args, kwargs = json.loads(atrs['input'])
                print(task_list)
                print('after defs')
                print(args)
                print(kwargs)
                id = atrs['activityId']
                if name == 'sum':
                    result = sum(args)
                elif name == 'square':
                    result = square(*args)
                print('after res')
                global running, pq, nq, bq
                running.append(id)
                nrez = JSObject({'id': id, 'name': name, 'inputs': atrs['input'],
                    'result': result
                })
                print(nrez)
                if task_list == 'priority_queue':
                    pq.push(nrez)
                elif task_list == 'normal_queue':
                    nq.push(JSObject(nrez))
                else:
                    bq.push(nrez)
            elif dt == 'Else':
                pass

import traceback

def indent(string, count=1):
    return "\n".join(' '*4*count + line for line in string.split('\n'))


class WorkflowProxy(object):
    def __init__(self, task_id, version):
        self.scheduler = None
        self._kwargs = dict(
            task_id=(task_id, version), 
            decision_duration=0,
            workflow_duration=0,
            task_list='normal_queue',
            retry=0,
            delay=0,
            error_handling=False
        )

    def __call__(self, *args, **kwargs):
        print(self._kwargs)
        return self.scheduler.remote_subworkflow(
            args=args, kwargs=kwargs,
            args_serializer=self._serialize_arguments,
            result_deserializer=self._deserialize_result,
            **self._kwargs
        )

    def _serialize_arguments(self, *args, **kwargs):
        return json.dumps([args, kwargs])

    def _deserialize_result(self, result):
        return json.loads(result)

class ActivityProxy(object):
    def __init__(self, task_id, version):
        self.scheduler = None
        self._kwargs = dict(
            task_id=(task_id, version),
            heartbeat=0,
            schedule_to_close=0,
            schedule_to_start=0,
            start_to_close=0,
            task_list='normal_queue',
            retry=0,
            delay=0,
            error_handling=False
        )

    def __call__(self, *args, **kwargs):
        return self.scheduler.remote_activity(
            args=args, kwargs=kwargs,
            args_serializer=self._serialize_arguments,
            result_deserializer=self._deserialize_result,
            **self._kwargs
        )

    def _serialize_arguments(self, *args, **kwargs):
        return json.dumps([args, kwargs])

    def _deserialize_result(self, result):
        return json.loads(result)

cls_header = "
class MyWorkflow(Workflow):
    sum = ActivityProxy('sum', 1)
    square = ActivityProxy('square', 1)

    def run(self):
"
def run(event):
    global running, errors, timedout, results
    running = []
    errors = {}
    timedout = []
    results = {}

    txt = doc['yourcode']

    cls_def = cls_header + indent(txt.value, 2)
    print(cls_def)
    try:
        exec(cls_def, globals())
        sched = OptionsScheduler(
                    ArgsDependencyScheduler(
                        DecisionScheduler(
                            client=Client(),
                            token='token',
                            running=running,
                            timedout=timedout,
                            results=results,
                            errors=errors
                    )
                )
            )
        MyWorkflow.sum.scheduler = sched
        MyWorkflow.square.scheduler = sched
        wf = MyWorkflow('[[], {}]', sched)
        value = wf()
        print(sched._decisions._data)
        print(value)
    except Exception as exc:
        traceback.print_exc()

doc['run_button'].bind('click', run)
</script>
<script type="text/javascript">
brython()
</script>
</body>
</html>
