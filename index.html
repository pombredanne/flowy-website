<html>
<head>
    <title>Flowy</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <link rel="stylesheet" href="css/index.css" type="text/css" media="screen" title="no title" charset="utf-8">
</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Flowy</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">Documentation</a></li>
            <li><a href="#">Contribute</a></li>
            <li><a href="#">Download</a></li>
            <li><a href="#">Contact</a></li>
          </ul>
          <form class="navbar-form navbar-right">
            <input type="text" class="form-control" placeholder="Search...">
          </form>
        </div>
      </div>
    </div>
<div class="container">
    <div class="row">
        <div class="col-md-4 col-md-offset-4">
            <h3>Try Flowy</h3>
        </div>
    </div>
    <div class="row">
        <div class="col-md-5">
            <pre id="flowy_workflow">
@Workflow('MyWorkflow', 4, 'my_list')
class MyWorkflow(Workflow):
    sum = ActivityProxy('sum', 1)
    square = ActivityProxy('square', 1)

    def run(self, input): </pre>
            <textarea id="yourcode" cols="40" rows="10">self.sum(1,2,3)
self.square(2)</textarea>
            <button type="button" class="center-block" id="run_button">Run</button>
            <pre id="output"> </pre>
        </div>
        <div class="col-md-6">
            <div id="priority_queue" class="stack_wrapper">
                <div class="stack">
                    <div class="activity">
                        <span class="name">sum</span>
                        <span class="inputs">[1,2,3]</span>
                        <span class="result">6</span>
                        <button class="finish"><span class="glyphicon glyphicon-ok"></span></button>
                        <button class="error"><span class="glyphicon glyphicon-remove"></span></button>
                        <button class="timeout"><span class="glyphicon glyphicon-time"></span></button>
                    </div>
                    <div class="activity">
                        <span class="name">square</span>
                        <span class="inputs">[2]</span>
                        <span class="result">4</span>
                        <button class="finish"><span class="glyphicon glyphicon-ok"></span></button>
                        <button class="error"><span class="glyphicon glyphicon-remove"></span></button>
                        <button class="timeout"><span class="glyphicon glyphicon-time"></span></button>
                    </div>
                </div>
                <div class="queue_name">
                    Priority queue
                </div>
            </div>
            <div id="normal_queue" class="stack_wrapper">
                <div id="normal" class="stack">
                
                </div>
                <div class="queue_name">
                    Normal queue
                </div>
            </div>
            <div id="backup_queue" class="stack_wrapper">
                <div class="stack">
                
                </div>
                <div class="queue_name">
                    Backup queue
                </div>
            </div>
        </div>
    </div>
</div>

<script src="js/jquery.js" type="text/javascript"></script>
<script src="js/Ractive.js" type="text/javascript"></script>
<script src="js/brython.js" type="text/javascript"></script>
<script src="js/bootstrap.min.js" type="text/javascript"></script>
<script type="text/python">
from browser import doc
import traceback
def indent(string, count=1):
    return "\n".join('    '*count + line for line in string.split('\n'))

class SuspendTask(Exception):
    """ Raised to suspend the task run.

    This happens when a worklfow needs to wait for an activity or in case of an
    async activity.
    """


class TaskError(Exception):
    """ Raised from an activity or subworkflow task if error handling is
    enabled and the task fails.
    """


class TaskTimedout(TaskError):
    """ Raised from an activity or subworkflow task if any of its timeout
    timers were exceeded.
    """

class Placeholder(object):
    def result(self):
        raise SuspendTask()


class Error(object):
    def __init__(self, reason):
        self._reason = reason

    def result(self):
        raise TaskError(self._reason)


class Timeout(object):
    def result(self):
        raise TaskTimedout()


class Result(object):
    def __init__(self, result):
        self._result = result

    def result(self):
        return self._result

def workflow(*args, **kwargs):
    def wrapper(func):
        return func()
    return wrapper

def check(func, args):
    if call_id in running:
        return Placeholder()
    if call_id in timedout:
        return Timeout()
    if call_id in errors:
        return Error(errors[call_id])
    if call_id in results:
        return Result(func(args))
    running.append(call_id)
    return Placeholder()

def sum_args(*args):
    print('sarg')
    res = check(sum, args)
    print('res')
    global call_id
    call_id += 1
    return res

def square(x):
    res = check(lambda x: x**2, x)
    global call_id
    call_id += 1
    return res

def ActivityProxy(name, *args):
    print(name)
    if name == 'sum':
        return sum_args
    if name == 'square':
        return square

call_id = 0
running = []
timedout = []
results = {}
errors = {}

class Workflow(object):
    pass

cls_header = "
@workflow('MyWorkflow', 4, 'my_list')
class MyWorkflow(Workflow):
    sum = ActivityProxy('sum', 1)
    square = ActivityProxy('square', 1)

    def run(self):
"
def run(event):
    txt = doc['yourcode']

    cls_def = cls_header + indent(txt.value, 2)
    print(cls_def)
    try:
        exec(cls_def, globals())
        wf = MyWorkflow()
        value = wf.run()
        print(value)
    except Exception as exc:
        traceback.print_exc()

doc['run_button'].bind('click', run)
</script>
<script type="text/javascript">
brython()
</script>
</body>
</html>
